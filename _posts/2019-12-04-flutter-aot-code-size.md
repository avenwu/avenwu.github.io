---
layout: post
title: "è½»æ¾æŒæ¡AOTäº§ç‰©å¤§å°"
description: "Dart AOTäº§ç‰©å¤§å°åˆ†æå·¥å…·"
header_image: /assets/img/2019-12-04-01.jpg
keywords: ""
tags: [Flutter]
---
{% include JB/setup %}
![img](/assets/img/2019-12-04-01.jpg)

* ç›®å½•
{:toc #markdown-toc}

ä¸ºäº†æ§åˆ¶Flutteræ··åˆå¼€å‘åï¼ŒåŒ…ä½“ç§¯ä¸è‡³äºè¿‡å¤§ã€‚æˆ‘ä»¬éœ€è¦äº†è§£Flutteræ„å»ºAppåçš„äº§ç‰©ï¼Œå…¶ä¸­ä¸å¼€å‘è€…å…³ç³»å¯†åˆ‡çš„æ˜¯Dartä¸šåŠ¡ä¾§äº§ç”Ÿçš„æœºå™¨ç ã€‚ä¹Ÿå°±æ˜¯æœ¬æ–‡å°†åˆ†æçš„Dart AOTäº§ç‰©ã€‚

æ ¹æ®Flutter FAQçš„è§£ç­”[How big is the Flutter engine?](https://flutter.dev/docs/resources/faq#how-big-is-the-flutter-engine)ï¼Œ
> Androidæ¥å…¥Flutteråï¼Œè‡³å°‘å¢åŠ 4.3MBï¼Œå…¶ä¸­å¼•æ“3.2MBï¼›
> iOSçº¦10.9MBï¼Œéƒ¨åˆ†åŸå› æ˜¯IPAçš„åŠ å¯†å¯¼è‡´å‹ç¼©ç‡é™ä½;

å…¶ä¸­å¼•æ“å æ®å¤§éƒ¨åˆ†,éšç€ä¸šåŠ¡æ¨¡å—ç»„ä»¶å¢å¤šï¼Œä½“ç§¯å¢åŠ é€Ÿåº¦ç›¸å¯¹å¹³ç¼“ã€‚

äº†è§£AOTæ„å»ºäº§ç‰©æ˜¯ä¸ºäº†æŒæ¡å‡å°ä½“ç§¯çš„æ–¹æ³•ã€‚é€šè¿‡ä¼˜åŒ–æ„å»ºå‚æ•°å¯ä»¥åœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ä¸€èˆ¬å¯ä»¥å‡å°‘çº¦8%çš„å¤§å°ã€‚å½“ç„¶é…åˆä»£ç ä¼˜åŒ–è¿˜ä»¥åœ¨å‡å°‘ä¸€äº›ã€‚

çœ‹ä¸€ä¸‹å¼•å…¥æœºå™¨ç ä¼˜åŒ–åçš„å‡ ä»½æ•°æ®ï¼š

| æ¡ˆä¾‹å·¥ç¨‹        | AOTäº§ç‰©å‡å°ç™¾åˆ†æ¯” |
| :---------------: | :-----------------: |
| flutter_gallery | æ€»å¤§å°å‡å°‘~8.7%   |
| é—²é±¼            | æ€»å¤§å°å‡å°‘~8.7%   |
| å®‰å±…å®¢"æœ‰æ–™"    | app.soå¯ä»¥å‡å°~8% |

*æ³¨ï¼šé—²é±¼æ•°æ®æ¥æºäºå…¶å¯¹å¤–åˆ†äº«æ•°æ®ï¼ŒæœªåšéªŒè¯*

ä¸‹é¢æ˜¯ç¬”è€…æœ¬æœºæµ‹è¯•çš„æœ‰æ–™æ•°æ®ï¼š
```
7840264 bytes =ã€‹ 7.48MB
7193096 bytes =ã€‹ 6.86MB
```

æœ¬æ–‡æ ‡é¢˜ä¸ºã€Šè½»æ¾æŒæ¡AOTäº§ç‰©å¤§å°ã€‹ï¼Œå…¶å®è¦æŒæ¡AOTäº§ç‰©æ˜¯æ¯”è¾ƒéš¾çš„ï¼Œä¸å­˜åœ¨è½»æ¾çš„æ–¹æ³•ğŸ™ƒã€‚ä½†æ—¢ç„¶ä½ å·²ç»æ‰“å¼€äº†æ–‡ç« ï¼Œä¸å¦¨ç»§ç»­äº†è§£ä¸‹ã€‚

## Dart AOTäº§ç‰©
`Dart VM`æ”¯æŒJITå’ŒAOTæ¨¡å¼ï¼Œåœ¨å®é™…å¼€å‘Flutterçš„è¿‡ç¨‹ä¸­ï¼Œå¼€å‘ç¯å¢ƒä¸‹èµ°çš„æ˜¯JITã€‚æˆ‘ä»¬é€šè¿‡releaseæ„å»ºï¼Œå¯ä»¥ç”Ÿæˆdartçš„AOTä»£ç ã€‚

è¿™é‡Œæ²¡æœ‰æŒ‡å®šAndroid/iOSå¹³å°ï¼Œæœ‰éœ€è¦ä¹Ÿå¯ä»¥æŒ‡å®šï¼Œé»˜è®¤ä¼šç”Ÿæˆandroid-armæ¶æ„ã€‚

> flutter build aot --release

é’ˆå¯¹Androidæ¥è¯´ä¼šç”Ÿæˆapp.soï¼Œä»–çš„ç›®å½•åœ¨`build`ä¸‹ï¼š
> flutter build aot --release --target-platform=android-arm64

```
â”œâ”€â”€ aot
â”‚Â Â  â”œâ”€â”€ app.dill
â”‚Â Â  â”œâ”€â”€ app.so
â”‚Â Â  â”œâ”€â”€ frontend_server.d
â”‚Â Â  â”œâ”€â”€ gen_snapshot.d
â”‚Â Â  â””â”€â”€ kernel_compile.d
```
é’ˆå¯¹iOSæ¥è¯´ä¼šç”ŸæˆApp.frameworkï¼Œ

> flutter build aot --release --target-platform=ios --ios-arch=arm64

```
â”œâ”€â”€ aot
â”‚Â Â  â”œâ”€â”€ App.framework
â”‚Â Â  â”‚Â Â  â””â”€â”€ App
â”‚Â Â  â”œâ”€â”€ App.framework.dSYM.noindex
â”‚Â Â  â”‚Â Â  â””â”€â”€ Contents
â”‚Â Â  â”‚Â Â      â””â”€â”€ Resources
â”‚Â Â  â”‚Â Â          â””â”€â”€ DWARF
â”‚Â Â  â”‚Â Â              â””â”€â”€ App
â”‚Â Â  â”œâ”€â”€ app.dill
â”‚Â Â  â”œâ”€â”€ arm64
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ App.framework
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ App
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ App.framework.dSYM.noindex
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ Contents
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ Info.plist
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ Resources
â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ DWARF
â”‚Â Â  â”‚Â Â  â”‚Â Â              â””â”€â”€ App
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ gen_snapshot.d
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ snapshot_assembly.S
â”‚Â Â  â”‚Â Â  â””â”€â”€ snapshot_assembly.o
â”‚Â Â  â”œâ”€â”€ frontend_server.d
â”‚Â Â  â””â”€â”€ kernel_compile.d
```

å½“ç„¶æ„å»ºipaå’Œapkçš„è¯è¿˜ä¼šæœ‰å…¶ä»–çš„äº§ç‰©ï¼Œä¸»è¦åœ¨flutter_assetsç›®å½•ä¸­ã€‚

## AOTç¼–è¯‘å·¥å…·
æœ€ç®€å•çš„ç¼–è¯‘æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬æ²¡æœ‰å¹²é¢„AOTçš„ç¼–è¯‘å‚æ•°ï¼Œé€šè¿‡ä¸º`gen_snapshot`å·¥å…·é™„åŠ å‚æ•°ï¼Œå¯ä»¥å®ç°æ›´ç²¾ç»†çš„é…ç½®å’Œè¾“å‡ºã€‚

gen_snapshotæ‰€æ”¯æŒçš„å‚æ•°ï¼Œç›®å‰å¥½åƒæ²¡æœ‰åŠæ³•é€šè¿‡flutter helpè¿›è¡Œè¾“å‡ºï¼Œæœ€ç¡¬çš„æ–¹æ³•æ˜¯å»åˆ†æç¼–è¯‘æµç¨‹çš„æºç ã€‚
é€šè¿‡è¿½åŠ `--extra-gen-snapshot-options`å‚æ•°,å¹¶ä¸ºä»–é™„ä¸Šå…·ä½“çš„äºŒçº§å‚æ•°ï¼Œå¯ä»¥å®ç°å¾ˆå¤šé…ç½®ï¼Œæ¯”å¦‚

> flutter build aot --release --extra-gen-snapshot-options="--dwarf_stack_traces,--print-snapshot-sizes,--print_instructions_sizes_to=build/aot.json"

å…³äºgen_snapshotçš„æµç¨‹ï¼Œè¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥é˜…æ–‡æ¡£, ä¹Ÿæœ‰ä¸å°‘åˆ†æçš„æ–‡ç« ï¼Œå¦‚ï¼šhttp://gityuan.com/2019/09/21/flutter_gen_snapshot/

## å¤§å°æ•°æ®åˆ†æ
åœ¨[Flutterç˜¦èº«å¤§ä½œæˆ˜](https://www.yuque.com/xytech/flutter/hnxs1g)ä¸€æ–‡ä¸­ï¼Œé—²é±¼å¼€å‘è€…åˆ†äº«äº†ä»–ä»¬å¯¹åŒ…å¤§å°çš„æ¢ç´¢ã€‚ä»ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œä¸ºäº†äº†è§£åŒ…å¤§å°æ¿€å¢åŸå› ï¼Œé—²é±¼å›¢é˜Ÿåœ¨githubä¸Šå‘Flutterå›¢é˜Ÿæèµ·äº†å¤šä¸ªissueså’¨è¯¢ã€‚
é€šè¯»å®Œæ•´ä¸ªæ²Ÿé€šæµç¨‹åï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€äº›æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼šflutterå¼€å‘å›¢é˜Ÿæä¾›äº†ä¸€äº›ç”¨äºæ£€æµ‹aotä»£ç çš„å·¥å…·ã€‚

åˆ°æœ¬æ–‡æ’°å†™çš„æ—¶å€™,å¯ä»¥é…ç½®çš„å¤§å°å‚æ•°æœ‰ä»¥ä¸‹å‡ ä¸ªï¼Œéƒ½æ˜¯é…ç½®gen_snapshotçš„æ„å»ºå‚æ•°ï¼š

* --print-snapshot-sizes
* --print-instructions-sizes-to è¾“å‡ºaotç”Ÿæˆä»£ç çš„å¤§å°
* --write-v8-snapshot-profile-to è¾“å‡ºaotä»£ç ä¸­æ‰€æœ‰ç±»çš„v8å¿«ç…§æ ¼å¼æ–‡ä»¶

äº§å‡ºçš„æ•°æ®éƒ½æ˜¯jsonæ ¼å¼ï¼Œå¯ä»¥åˆ©ç”¨dartè„šæœ¬å’ŒChromeå¯è§†åŒ–åˆ†æã€‚

### "å¿«ç…§"å¤§å°
æœ€ç®€ç»ƒçš„å¤§å°æ•°æ®ï¼Œæ˜¯è¾“å‡ºæœºå™¨ç äº§ç‰©ä¸­ä¸åŒæˆåˆ†å¤§å¤§å°æƒ…å†µï¼š
![](/assets/images/print-snapshot-sizes.png)

å…¶ä¸­çš„å‡ ä¸ªæˆåˆ†ï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°æ¯”è¾ƒè¯¦ç»†çš„è¯´æ˜ï¼Œç®€å•äº†è§£ä¸‹å¤§æ¦‚å«ä¹‰

* ç”Ÿæˆçš„ä»£ç  Instructions are the generated code. 
* æœºå™¨ç çš„å…ƒæ•°æ® ReadOnlyData are generated code metadata (PcDescriptor, StackMap, CodeSourceMap) and strings
* å…¶ä»–å‰©ä½™å¯¹è±¡ï¼Œæ¯”å¦‚å¸¸é‡ï¼ŒVMçš„å…ƒæ•°æ®å¦‚ç±»ï¼Œæ–¹æ³• Isolate/VMIsolate are the rest of objects. (e.g. constants you have written in your code and any other VM specific metadata like Class, Function etc objects).

### "æŒ‡ä»¤"å¤§å°
é™¤äº†æŒ‰å¿«å½’æ¡£çš„å¤§å°ä¿¡æ¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æƒ³åŠæ³•å¾—åˆ°dartç¼–è¯‘åï¼Œä¸åŒä»£ç æŒ‡ä»¤çš„å¤§å°ä¿¡æ¯ã€‚
é€šè¿‡æŒ‡å®š`--print-instructions-sizes-to`è¾“å‡ºçš„æœºå™¨ç æŠ¥å‘Šï¼Œå¹¶åˆ¶å®šè¾“å‡ºçš„æ–‡ä»¶åï¼Œä»–çš„æ ¼å¼æ˜¯json.

![](/assets/images/aot-code-size.gif)

è¿™ä¸ªæŠ¥å‘Šå¯ä»¥å¿«é€Ÿå±•ç¤ºå“ªäº›ä»£ç å—çš„ä½“ç§¯å¤§ï¼Œæ¯”å¦‚ç”±äºasè¯­æ³•å¯¼è‡´çš„è‡ªåŠ¨ç”Ÿæˆå¼‚å¸¸æ£€æµ‹å’ŒæŠ›å‡ºçš„ä»£ç ã€‚åŸæœ¬å‡ ä¸ªå­—ç¬¦çš„ä»£ç ï¼Œç¬é—´å˜æˆå‡ åå­—ç¬¦ä»£ç 
æ¯”å¦‚ `x as String` ä¼šç”Ÿæˆç±»ä¼¼ä¸‹é¢ä¸€æ®µä»£ç ï¼Œå› æ­¤å¤§é‡ä½¿ç”¨asè¯­æ³•å°†ä¼šæˆå€å¢é•¿ä»£ç é‡ã€‚
```
if (x.classId < A && x.classId > B) throw "x is not subtype of String";
```
æ ¹æ®å¼€å‘è€…é€éœ²çš„ä¿¡æ¯ï¼Œç›®å‰å·²ç»å¯¹ä»£ç ç”Ÿæˆé‡åšäº†ä¼˜åŒ–ï¼šhttps://dart-review.googlesource.com/c/78748

### v8æ ¼å¼å¿«ç…§ä¿¡æ¯
æ¯é”™ï¼Œè¿™ä¸ªv8å’ŒChromeçš„V8æ˜¯åŒä¸€ä¸ªå•è¯ã€‚è¾“å‡ºaotä»£ç ä¸­æ‰€æœ‰ç±»çš„v8å¿«ç…§æ ¼å¼æ–‡ä»¶ï¼Œæ ¼å¼ä¹Ÿæ˜¯jsonï¼Œä½†æ˜¯ä¸ºäº†Chromeèƒ½å¤Ÿæ‰“å¼€ï¼Œå¯ä»¥å‘½åä¸º.heapsnapshotåç¼€ï¼Œå¯¹æ•°æ®æ ¼å¼æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç ”ç©¶ä¸‹å…¶å­—æ®µçš„å«ä¹‰ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ç”¨GUIæŸ¥çœ‹äº†ã€‚

![](/assets/images/aot-code-object-level-size.png)

è¿™ä¸ªåŠŸèƒ½è¯´å®è¯ï¼Œæˆ‘åˆ°ç°åœ¨ä¹Ÿæ²¡ææ˜ç™½æ€ä¹ˆå¿«é€Ÿä¸Šæ‰‹ï¼Œè™½ç„¶æ˜¯å¯è§†åŒ–æ˜¾ç¤ºäº†æ‰€ä»¥å¯¹è±¡çº§åˆ«çš„å¤§å°æ•°æ®ï¼Œä½†æ˜¯ä¼¼ä¹æ²¡æœ‰é—®é¢˜æ£€æµ‹åŠŸèƒ½ã€‚å› æ­¤åœ¨æ²¡æœ‰å…·ä½“å¯ä½¿ç”¨çš„åœºæ™¯ä¸‹ï¼Œä¹Ÿåªèƒ½ä½œä¸ºä¸€ä»½æ•°æ®çœ‹ä¸€ä¸‹äº†ã€‚

### å»é™¤å †æ ˆè·Ÿè¸ªç¬¦å·&æ··æ·†
æ—¢ç„¶æ˜¯ç”Ÿæˆæœºå™¨ç ï¼Œé‚£å°±å­˜åœ¨ç±»ä¼¼stripçš„æ¦‚å¿µï¼Œå½“ç„¶è¿˜æœ‰å„ç§è¯­è¨€éƒ½æœ‰çš„ä»£ç æ··æ·†èƒ½åŠ›ã€‚

* --dwarf_stack_trace è¡¨ç¤ºåœ¨ç”Ÿæˆçš„åŠ¨æ€åº“æ–‡ä»¶ä¸­ï¼Œä¸ä½¿ç”¨å †æ ˆè·Ÿè¸ªç¬¦å·
* --obfuscate è¡¨ç¤ºæ··æ·†ï¼Œé€šè¿‡å‡å°‘å˜é‡å/æ–¹æ³•åçš„æ–¹å¼å‡å°ä»£ç ä½“ç§¯


## Dart VMå·¥å…·

Dart SDKæœ¬èº«ä¹Ÿæä¾›äº†ä¸€äº›å·¥å…·ï¼Œå…·ä½“åœ¨[pkg/vm/bin/](https://github.com/dart-lang/sdk/pkg/vm/bin/)ç›®å½•ä¸‹ï¼›

> pkg/vm/bin/compare_sizes.dart 

å¯¹æ¯”å¤šä»½aotçš„ä»£ç å¤§å°

> pkg/vm/bin/run_binary_size_analysis.dart

å°†--print-instructions-sizes-toç”Ÿæˆçš„jsonæ•°æ®è½¬å¯¼å‡ºHtmlçš„å¯è§†åŒ–æŠ¥å‘Š

æé†’ä¸€ä¸‹ï¼ŒFlutter SDKè™½ç„¶ä¼šè‡ªåŠ¨ä¸‹è½½Dart SDKåˆ°bin/cacheç›®å½•ï¼Œä½†æ˜¯å¹¶ä¸åŒ…æœ¬æ–‡é—®é¢˜æåˆ°çš„VMå·¥å…·ï¼Œéœ€è¦çš„è¯è¦ä¸»åŠ¨ç‚¹å§ï¼Œå»githubä¸Šcloneæˆ–è€…å•ç‹¬å‰¥å‡ºDartè„šæœ¬å‡ºæ¥ï¼Œåƒä¸‡ä¸è¦å»Flutterç›®å½•ä¸‹ç”Ÿæ‰¾äº†ï¼Œä½ æ‰¾ä¸åˆ°çš„ğŸ˜…ã€‚

å‹æƒ…æä¾›ä¸€ä»½å‰¥ç¦»å¥½çš„è„šæœ¬ï¼Œä¸‹è½½åè§£å‹åˆ°å·¥ç¨‹çš„æµ‹è¯•ç›®å½•`test`ä¸‹ï¼Œç„¶åå°±å¯ä»¥åˆ©ç”¨ä¸€äº›å‘½ä»¤ç”Ÿæˆå¯è§†åŒ–çš„HTMLæŠ¥å‘Šäº†ã€‚
> ä¼ é€åœ°å€ =ã€‹[drart-vm-tools.tar.gz](/assets/files/drart-vm-tools.tar.gz)

![](/assets/images/run-dart-size.png)

## å°ç»“
ç˜¦èº«æ˜¯ä¸€ä»¶ä¸å®¹æ˜“çš„äº‹æƒ…ï¼Œå¾ˆå¤šæ—¶å€™è‹è‡å†å°ä¹Ÿæ˜¯è‚‰ã€‚

## å‚è€ƒ
* https://www.yuque.com/xytech/flutter/hnxs1g
* https://github.com/flutter/flutter/issues/21813
* https://github.com/flutter/flutter/issues/18693
* https://github.com/dart-lang/sdk/blob/master/runtime/docs/aot_binary_size_analysis.md
